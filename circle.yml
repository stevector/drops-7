# https://circleci.com/docs/configuration#machine
machine:
  timezone:
    America/Chicago
  php:
    # https://circleci.com/docs/build-image-trusty/#php
    version: 7.0.11
  environment:
    TERMINUS_ENV: ci-$CIRCLE_BUILD_NUM
    TERMINUS_SITE: ci-drops-7
    TESTS_DIR: ~/tests
    PATH: $PATH:~/.composer/vendor/bin:~/.config/composer/vendor/bin

dependencies:
  cache_directories:
    - ~/.composer/cache
  override:
    - cd ~ && git clone git@github.com:stevector/ci-drops-7.git tests
    # It is possible that we are testing a new branch in drops-7, and that
    # branch has corresponding changes in the testing repo in a branch of
    # the same name.
    # If that branch doesn't exist the command will throw an error so also
    # use true.
    - cd $TESTS_DIR && git checkout $CIRCLE_BRANCH || true
    - cd $TESTS_DIR && composer install

    - ./test/git-config.sh
    - ./test/install-globals.sh

  post:
    # drops-7 does not provide a settings.php file
    - cp sites/default/default.settings.php sites/default/settings.php
    - terminus auth:login -n --machine-token="$TERMINUS_TOKEN"
    - terminus build-env:delete:ci -n "$TERMINUS_SITE" --keep=4 --yes
    - terminus env:wake -n "$TERMINUS_SITE.dev"
    - terminus build-env:create -n "$TERMINUS_SITE.dev" "$TERMINUS_ENV" --yes --notify="$NOTIFY"
test:
  override:
    - cd $TESTS_DIR && ./scripts/run-behat
