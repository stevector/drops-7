# https://circleci.com/docs/configuration#machine
machine:
  timezone:
    America/Chicago
  php:
    # https://circleci.com/docs/build-image-trusty/#php
    version: 7.0.11
  environment:
    TERMINUS_ENV: ci-$CIRCLE_BUILD_NUM
    TERMINUS_SITE: ci-drops-7
    # For some reason, relative paths like "~/tests" did not work.
    TESTS_DIR: /home/ubuntu/tests
    SITE_DIR: /home/ubuntu/drops-7
    PATH: $PATH:~/.composer/vendor/bin:~/.config/composer/vendor/bin

dependencies:
  cache_directories:
    - ~/.composer/cache
  override:
    - cd ~ && git clone git@github.com:stevector/ci-drops-7.git tests
    # It is possible that we are testing a new branch in drops-7, and that
    # branch has corresponding changes in the testing repo in a branch of
    # the same name.
    # If that branch doesn't exist the command will throw an error so also
    # use true.
    - cd $TESTS_DIR && git checkout $CIRCLE_BRANCH || true
    - cd $TESTS_DIR && composer install

    - ./test/git-config.sh
    - ./test/install-globals.sh
  post:
    - ./test/create-env.sh
test:
  override:
    - cd $TESTS_DIR ~/tests && ./scripts/run-behat
